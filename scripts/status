#!/usr/bin/bash

check-uptime() {
    printf "%15s : %s\n" "Uptime" "$(uptime -p | cut -d " " -f2-)"
}

check-packages() {
    output=$(paru -Q | wc -l)
    output2=$(checkupdates | wc -l)
    if [ "$output2" == "0" ]; then
        update=""
    else
        update="($output2 to update)"
    fi

    printf "%15s : %s %s\n" "Packages" "$output" "$update"
}

check-disk-usage() {
    printf "%15s :\n" "Disk"
    lsblk -dno NAME,LABEL | awk '$1!=""{print $1,$2}' | while read disk label; do
        total=$(lsblk -bno SIZE /dev/$disk | head -n1)
        # Sum used space for all partitions of this disk
        used=$(df -B1 --output=source,used 2>/dev/null | awk -v d="/dev/$disk" '$1 ~ ("^" d) {sum+=$2} END{print sum}')

        if [ -n "$used" ]; then
            pct=$((100 * used / total))
            name="$disk"
            [ -n "$label" ] && name="$disk ($label)"

            # Determine if this is the root disk
            # root_part=$(df / --output=source | tail -1)
            # root_disk=$(lsblk -no PKNAME "$root_part")

            # main_disk=""
            # [ "$disk" == "$root_disk" ] && main_disk="[OS Disk]"

            # Collect mount points for all partitions on this disk
            mounts=$(lsblk -ln -o NAME,MOUNTPOINT /dev/$disk | awk '$2!=""{printf "%s ", $2}' | sed 's/ $//')

            # printf "%25s, %3s%% used, %9s %s\n" "$name" "$pct" "$main_disk" "$mounts"
            printf "%20s%-20s, %2s%% used, mount point: %s\n" " " "$name" "$pct" "$mounts"
        fi
    done
}

check-keymap() {
    printf "%15s : %s\n" "Keymap" "$(hyprctl devices -j | jq '.keyboards | .[] | select(.main == true) | .active_keymap' -r)"
}

check-uptime
check-packages
check-keymap
check-disk-usage
